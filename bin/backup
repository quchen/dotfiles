#!/usr/bin/env bash

set -euo pipefail

set +x

excludes() {
    cat <<EOF
.stack-work
$HOME/.atom/.apm
$HOME/.atom/.node-gyp
$HOME/.atom/compile-cache
$HOME/.cabal
$HOME/.cache
$HOME/.cargo
$HOME/.gradle
$HOME/.local/share/Trash
$HOME/.npm
$HOME/.rustup
$HOME/.stack
$HOME/.thumbnails
$HOME/.zoom
$HOME/**/.terraform
$HOME/Downloads
$HOME/Dropbox-*
$HOME/snap
$HOME/temp
EOF
}

iexcludes() {
    cat <<EOF
$HOME/.config/**/cache
EOF
}

export -f excludes
export -f iexcludes

restic backup \
    --exclude-file=<(excludes) \
    --iexclude-file=<(iexcludes) \
    --exclude-if-present .skip-restic-backup \
    --with-atime=true \
    --one-file-system \
    "$HOME" \
    "$@"
