#!/usr/bin/env bash

set -euo pipefail

exclude="$(cat <<'EOF'
.atom/.apm/***
.atom/.node-gyp/***
.atom/compile-cache/***
.cabal/***
.cache/***
.cargo/***
.local/share/Trash/***
.rustup/***
.stack/***
.thumbnails/***
Downloads/***
Dropbox*
snap/***
temp/***
Videos/***
EOF
)"

backup_target_dir=${1:?'Backup target dir argument missing'}
shift
if [[ -d "$backup_target_dir" ]]; then
    # --archive = -rlptgoD
    #        -r = recursive
    #        -l = copy links as links
    #        -p = preserve permissions
    #        -t = preserve modification times,
    #        -g = preserve group,
    #        -o = preserve owner,
    #        -D = preserve devices and special files
    # --human-readable = numbers in human-readable format
    # --delete = delete extraneous files in target dir
    # --progress = show progress
    rsync "$HOME" "$backup_target_dir"      \
        --archive                           \
        --human-readable                    \
        --delete                            \
        --progress                          \
        --exclude-from <(echo "/$exclude")
else
    echo -e "\e[31mBackup dir not found: $backup_target_dir\e[0m"
    exit 1
fi
